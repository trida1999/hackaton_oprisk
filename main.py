from crewai import Agent, Task, Crew, Process
from langchain_openai import ChatOpenAI
from typing import Dict, List, Any, Optional
import json
from crewai.tools import tool
from striprtf.striprtf import rtf_to_text
import chardet
from langchain.memory import ConversationBufferMemory
import os
from dotenv import load_dotenv
import logging

# –î–æ–±–∞–≤—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
from langchain_core.messages import HumanMessage, SystemMessage

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
load_dotenv()
logging.basicConfig(level=logging.INFO)



# ----------------------------
# –ö–ª–∞—Å—Å –æ–±—â–µ–π –ø–∞–º—è—Ç–∏
# ----------------------------
class SharedMemory:
    def __init__(self):
        self.memory = ConversationBufferMemory()
        self.historical_data = {}
        self.insights = {}
    
    def add_conversation(self, agent_name: str, message: str):
        self.memory.chat_memory.add_user_message(f"{agent_name}: {message}")
    
    def add_historical_data(self, key: str, data: dict):
        self.historical_data[key] = data
    
    def add_insight(self, key: str, insight: str):
        self.insights[key] = insight
    
    def get_context(self) -> str:
        history = self.memory.load_memory_variables({})['history']
        insights = "\n".join([f"{k}: {v}" for k, v in self.insights.items()])
        return f"""
        –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:
        {history}
        
        –ö–õ–Æ–ß–ï–í–´–ï –ò–ù–°–ê–ô–¢–´:
        {insights}
        """

shared_memory = SharedMemory()

# ----------------------------
#  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM
# ----------------------------
llm = ChatOpenAI(
    model="openrouter/qwen/qwen3-14b:free",  # –£–±—Ä–∞–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å "openrouter/"
    openai_api_base="https://openrouter.ai/api/v1",
    openai_api_key=os.getenv("OPENROUTER_API_KEY"),
    temperature=0.3
)


# ----------------------------
# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞–º—è—Ç–∏
# ----------------------------
def readJson(file_path: str) -> Dict:
    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–µ—à–µ
    print(f"reading: {file_path}")
    with open(file_path, 'r', encoding='utf-8') as f:
        data = json.load(f)
        shared_memory.add_historical_data("latest_comments", data)
        return data

@tool
def access_comments() -> List[Dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –æ—Ç–¥–µ–ª–µ–Ω–∏—è—Ö"""
    print(f"access_comments")
    return readJson("reviews3.json")

@tool
def access_companies() -> List[Dict]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–± –æ—Ç–¥–µ–ª–µ–Ω–∏—è—Ö –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"""
    print(f"access_companies")
    return readJson("companies3.json")

@tool
def save_insight(insight: str) -> str:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Å–∞–π—Ç –≤ –ø–∞–º—è—Ç—å"""
    key = f"insight_{len(shared_memory.insights) + 1}"
    shared_memory.add_insight(key, insight)
    return f"–ò–Ω—Å–∞–π—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Å –∫–ª—é—á–æ–º: {key}"

@tool
def access_risk_methodology() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ 716-–ü –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É —Ä–∏—Å–∫—É"""
    return read_text_file("data/716p.txt")

@tool
def access_wrong_practices() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö"""
    return read_text_file("data/wrongPractices.txt")

# ----------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# ----------------------------
def read_text_file(file_path: str) -> str:
    with open(file_path, 'r', encoding='utf-8') as file:
        return file.read()

def read_rtf(file_path: str) -> str:
    with open(file_path, 'rb') as file:
        raw_content = file.read()
        encoding = chardet.detect(raw_content)['encoding']
        try:
            decoded_content = raw_content.decode(encoding or 'cp1251')
        except UnicodeDecodeError:
            decoded_content = raw_content.decode('cp1251', errors='replace')
    return rtf_to_text(decoded_content)

def generate_plan(question: str) -> List[str]:
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏
    context = shared_memory.get_context()
    
    # –®–∞–±–ª–æ–Ω –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM
    prompt = [HumanMessage(content=f"""
    **–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: {question}
    
    **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: 
    {context}
    
    **–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è**:
    - –ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤ (access_comments)
    - –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ (risk_analysis)
    - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Å–∞–π—Ç–æ–≤ (insights)
    - –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ (report)
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (critique)
    
    –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π JSON-—Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ. –ü—Ä–∏–º–µ—Ä:
    {{"tasks": ["risk_analysis", "insights", "report"]}}
    """)]
    # –ó–∞–ø—Ä–æ—Å –∫ LLM
    try:
        response = llm.invoke(prompt).content
        print(response)
        plan = json.loads(response)["tasks"]
        return plan
    except:
        return ["data_analysis", "risk_analysis", "insights", "report", "critique"]  # fallback

# ----------------------------
# –§–∞–±—Ä–∏–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤ —Å –ø–∞–º—è—Ç—å—é
# ----------------------------
def create_agent(
    role: str,
    goal: str,
    backstory: str,
    tools: list,
    allow_delegation: bool = False
) -> Agent:
    return Agent(
        role=role,
        goal=goal,
        backstory=backstory,
        tools=tools,
        llm=llm,
        verbose=True,
        memory=True,
        system_template=f"{backstory}\n\n–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:\n{shared_memory.get_context()}",
        allow_delegation=allow_delegation
    )

# ----------------------------
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤
# ----------------------------
senior_analyst = create_agent(
    role='–°—Ç–∞—Ä—à–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö',
    goal='–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç–∑—ã–≤–æ–≤ –∏ –≤—ã—è–≤–ª—è—Ç—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏, —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏, –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –±–∏–∑–Ω–µ—Å–æ–º',
    backstory='–û–ø—ã—Ç–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —Å 10-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Å—Ñ–µ—Ä–µ, —Ä–∞–±–æ—Ç–∞–ª –≤ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö, –∑–∞–Ω–∏–º–∞–ª –ø–æ–∑–∏—Ü–∏—é –≥–ª–∞–≤–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —Ä–æ–∑–Ω–∏—á–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞, –∫–∞–Ω–¥–∏–¥–∞—Ç —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö –Ω–∞—É–∫, –æ—á–µ–Ω—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π –∫ –¥–µ—Ç–∞–ª—è–º, –∏–∑–±–µ–≥–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤, —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–∏–ø–æ—Ç–µ–∑—ã',
    tools=[access_comments, access_companies, save_insight]
)

risk_assistant = create_agent(
    role='–†–∏—Å–∫-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç',
    goal='–ü—Ä–æ–≤–µ—Å—Ç–∏ –≥–ª—É–±–æ–∫–∏–π –≤—Å–µ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –∞–Ω–∞–ª–∏–∑, –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ –Ω–µ–¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–∑—ã–≤–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤',
    backstory='–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ä–∏—Å–∫–∞–º–∏ —Å –≥–ª—É–±–æ–∫–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ 716-–ü  '
              '–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º –æ–ø—ã—Ç–æ–º –≤—ã—è–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ –≤ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Å—Ñ–µ—Ä–µ. –Ø–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º –º–µ—Ç–æ–¥–∏–∫–∏ –ø–æ –≤—ã—è–≤–ª–µ–Ω–∏—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ä–∏—Å–∫–æ–º –∏ —Ä–∏—Å–∫–æ–º –ø–æ–≤–µ–¥–µ–Ω–∏—è, –±—ã–≤—à–∏–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –±–∞–Ω–∫–æ–≤, –≤—ã—Å—Ç—Ä–æ–∏–ª —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞, —Å–Ω–∏–∑–∏–≤ –ø–æ—Ç–µ—Ä–∏ –Ω–∞ 30%',
    tools=[access_comments, access_companies, access_wrong_practices, save_insight]
)

insights_agent = create_agent(
    role='–ê–≥–µ–Ω—Ç –≤—ã—è–≤–ª–µ–Ω–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤',
    goal='–í—ã—è–≤–ª—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –æ—Ç–¥–µ–ª–µ–Ω–∏—é –±–∞–Ω–∫–∞, —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã',
    backstory='–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö, —Å–ø–æ—Å–æ–±–Ω—ã–π –≤—ã–¥–µ–ª—è—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏–∑ –±–æ–ª—å—à–æ–≥–æ –æ–±—ä–µ–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å –∏—Ö –≤ —Å–∂–∞—Ç–æ–º –≤–∏–¥–µ, –≤–æ–∑–≥–ª–∞–≤–ª—è–ª –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–¥–µ–ª—ã –≤ –∫—Ä—É–ø–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö, –∏–º–µ–µ—Ç –±–æ–ª—å—à–æ–π –æ–ø—ã—Ç –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã—è–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏—á–∏–Ω–Ω–æ-—Å–ª–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–≤—è–∑–µ–π, —É—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –ø—Ä–∏–Ω—è—Ç–∏—é —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π.',
    tools=[save_insight]
)

report_builder = create_agent(
    role='–ê–≥–µ–Ω—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤',
    goal='–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã, –æ—Ç—Ä–∞–∂–∞—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π',
    backstory='–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å —Å –±–æ–ª—å—à–∏–º –æ–ø—ã—Ç–æ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –≤—ã—Å—à–µ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –±–∞–Ω–∫–∞, –∏–º–µ–µ—Ç –≥–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è –≤ –æ–±–ª–∞—Å—Ç–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏, –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –¥–µ—Ç–∞–ª—è–º, –±—ã–ª —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º –æ—Ç–¥–µ–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –≤ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–º –ë–∞–Ω–∫–µ',
    tools=[save_insight]
)

critic = create_agent(
    role='–ö—Ä–∏—Ç–∏–∫',
    goal='–û—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∏ –ø–æ–ª–Ω–æ—Ç—É –≤—ã–≤–æ–¥–æ–≤, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥—Ä—É–≥–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏, –ø—Ä–æ–≤–æ–¥—è —Ç—â–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–º –∞—Å–ø–µ–∫—Ç–∞–º, –¥–∞–≤–∞—Ç—å –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ü–µ–Ω–∫–∏',
    backstory='–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π —ç–∫—Å–ø–µ—Ä—Ç —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –º—ã—à–ª–µ–Ω–∏–µ–º, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–µ—Ä–µ–¥ –∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É. –ò–º–µ–µ—Ç –≥–ª—É–±–æ–∫–∏–µ –∑–Ω–∞–Ω–∏—è –∏ –±–æ–≥–∞—Ç—ã–π –æ–ø—ã—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ–º –∫ –¥–µ—Ç–∞–ª—è–º –∏ –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–æ–π —Å–¥–µ–ª–∞–Ω–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤, –≤–æ–∑–≥–ª–∞–≤–ª—è–ª –∫—Ä—É–ø–Ω–æ–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ',
    tools=[]
)

planner = create_agent(
    role='–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á',
    goal='–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–¥–∞—á –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞',
    backstory='–≠–∫—Å–ø–µ—Ä—Ç –≤ –∞–Ω–∞–ª–∏–∑–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏ –∏ –∑–Ω–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.',
    tools=[access_comments, access_companies, save_insight],
    allow_delegation=False
)

# ----------------------------
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
# ----------------------------
def create_analysis_tasks(question: str) -> List[Task]:
    
    plan = generate_plan(question)

    data_analysis_task = Task(
            description=f"–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤. –í–æ–ø—Ä–æ—Å: {question}. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ save_insight(insight='–≤–∞—à_—Ç–µ–∫—Å—Ç')",
            agent=senior_analyst,
            expected_output="–û—Ç—á–µ—Ç —Å —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏ –∏ –¥–∏–Ω–∞–º–∏–∫–æ–π –æ—Ü–µ–Ω–æ–∫"
        )

    risk_analysis_task = Task(
            description=f"""–ù–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–∑—ã–≤–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏ 
        –∏ —Å–ª—É—á–∞–∏ –Ω–µ–¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫ –≤ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –æ—Ç–¥–µ–ª–µ–Ω–∏—è—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–æ–≥–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—é 716-–ü –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö
          –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤. –í–æ–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {question}
–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ save_insight(insight='–≤–∞—à_—Ç–µ–∫—Å—Ç')""",
            agent=risk_assistant,
            expected_output="–û—Ç—á–µ—Ç –æ —Ä–∏—Å–∫–∞—Ö —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ 716-–ü"
        )

    insights_task = Task(
            description=f"""–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –≤—ã–≤–æ–¥–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
        1. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–¥–µ–ª–µ–Ω–∏—è
        2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
        3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é. –í–æ–ø—Ä–æ—Å: {question}
        –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∏–Ω—Å–∞–π—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ save_insight(insight='–≤–∞—à_—Ç–µ–∫—Å—Ç')""",
            agent=insights_agent,
            expected_output="–ö—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç —Å —Å–∏–ª—å–Ω—ã–º–∏ –∏ —Å–ª–∞–±—ã–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏"
        )

    report_task = Task(
            description=f"""–ù–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≤—Å–µ—Ö –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç, 
        –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ –≤–æ–ø—Ä–æ—Å: {question}
        –û—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
        1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º
        2. –°–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã
        3. –í–∫–ª—é—á–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
        4. –ë—ã—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–æ–ø-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É""",
            agent=report_builder,
            expected_output="""–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
        - –û—Ç–≤–µ—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        - –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã
        - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é""",
            output_file="report.md",
            context=[data_analysis_task, risk_analysis_task]
        )

    critique_task = Task(
            description=f""" –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞, –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π.
        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
        1. –ü–æ–ª–Ω–æ—Ç—É –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å: {question}
        2. –û–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–æ–≤""",
            agent=critic,
            expected_output="–õ–∏–±–æ 'APPROVED', –ª–∏–±–æ —Å–ø–∏—Å–æ–∫ –∑–∞–º–µ—á–∞–Ω–∏–π"
        )
    
    task_templates = {
        "data_analysis": data_analysis_task,
        "risk_analysis": risk_analysis_task,
        "insights": insights_task,
        "report": report_task,
        "critique": critique_task
    }
    
    # –°–±–æ—Ä–∫–∞ –∑–∞–¥–∞—á –ø–æ –ø–ª–∞–Ω—É
    tasks = []
    for task_name in plan:
        if task_name in task_templates:
            tasks.append(task_templates[task_name])

    shared_memory.add_historical_data("latest_plan", {"plan": plan, "question": question})
    
    return tasks

# ----------------------------
# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞
# ----------------------------
def analyze_bank_reviews(question: str) -> str:
    max_revisions = 2
    current_revision = 0
    approved = False
    final_report = None

    while not approved and current_revision < max_revisions:
        print("–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑")
        tasks = create_analysis_tasks(question)
        print("create_analysis_tasks done")
        print(current_revision)
        if current_revision > 0:
            print(current_revision)
            tasks[3].description += f"\n\n–ó–ê–ú–ï–ß–ê–ù–ò–Ø –ò–ó –ü–†–ï–î–´–î–£–©–ï–ô –ò–¢–ï–†–ê–¶–ò–ò:\n{shared_memory.get_context()}"
        print("crew")
        crew = Crew(
            agents=[senior_analyst, risk_assistant, insights_agent, report_builder, critic],
            tasks=tasks,
            process=Process.sequential,
            verbose=True
        )
        print("crew.kickoff")
        result = crew.kickoff()
        print("tasks_output")
        tasks_output = getattr(result, 'tasks_output', [None] * 5)
        print("report")
        report = str(tasks_output[3]) if tasks_output[3] else ""
        critique = str(tasks_output[4]) if tasks_output[4] else ""

        if "APPROVED" in critique:
            approved = True
            final_report = report
        else:
            shared_memory.add_conversation("Critic", critique)
            current_revision += 1

    return final_report if approved else f"{report}\n\n‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –¥–æ—Ä–∞–±–æ—Ç–æ–∫"

# ----------------------------
# –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
# ----------------------------
if __name__ == "__main__":
    try:
        print("üöÄ –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞...")
        shared_memory.add_conversation("System", "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞")
        result = analyze_bank_reviews("–í –∫–∞–∫–æ–º –æ—Ç–¥–µ–ª–µ–Ω–∏–∏ –±—ã–ª–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü?")
        print("\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç:", result)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")